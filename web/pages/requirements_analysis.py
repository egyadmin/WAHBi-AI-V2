import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

def show_requirements_analysis():
    """
    ุนุฑุถ ุตูุญุฉ ุชุญููู ูุชุทูุจุงุช ุงูููุงูุตุฉ
    """
    st.subheader("ุชุญููู ูุชุทูุจุงุช ุงูููุงูุตุฉ")
    
    # ุงูุชุญูู ูู ูุฌูุฏ ูุชุงุฆุฌ ุชุญููู ุณุงุจูุฉ
    if "analysis_results" not in st.session_state or not st.session_state.analysis_results:
        st.warning("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุชุญููู ูุชุงุญุฉ. ูุฑุฌู ุชุญููู ููุงูุตุฉ ุฃููุงู.")
        
        if st.button("ุงูุงูุชูุงู ุฅูู ุตูุญุฉ ุชุญููู ุงูููุงูุตุงุช"):
            st.session_state.page = "ุชุญููู ุงูููุงูุตุงุช"
            st.experimental_rerun()
            
        # ุนุฑุถ ุจูุงูุงุช ุชูุถูุญูุฉ
        st.markdown("### ุจูุงูุงุช ุชูุถูุญูุฉ ููุชุทูุจุงุช ุงูููุงูุตุฉ")
        
        sample_requirements = [
            {"ุงููุชุทูุจ": "ุชูุฑูุฏ ูุชุฑููุจ ูุนุฏุงุช ุงูุดุจูุฉ", "ุงูููุน": "ููู", "ุงูุฃููููุฉ": "ุนุงููุฉ", "ุงูุชุฎุตุต": "ุชูููุฉ ุงููุนูููุงุช"},
            {"ุงููุชุทูุจ": "ุชุฏุฑูุจ ุงูููุธููู", "ุงูููุน": "ุฅุฏุงุฑู", "ุงูุฃููููุฉ": "ูุชูุณุทุฉ", "ุงูุชุฎุตุต": "ุชุฏุฑูุจ"},
            {"ุงููุชุทูุจ": "ุชูููุฑ ุงูุตูุงูุฉ ููุฏุฉ 3 ุณููุงุช", "ุงูููุน": "ุชุนุงูุฏู", "ุงูุฃููููุฉ": "ุนุงููุฉ", "ุงูุชุฎุตุต": "ุตูุงูุฉ"},
            {"ุงููุชุทูุจ": "ุงูุงูุชุฒุงู ุจูุนุงููุฑ ุงูุฃูู ุงูุณูุจุฑุงูู", "ุงูููุน": "ุชูุธููู", "ุงูุฃููููุฉ": "ุนุงููุฉ", "ุงูุชุฎุตุต": "ุฃูู ุงููุนูููุงุช"},
            {"ุงููุชุทูุจ": "ูุณุจุฉ ูุญุชูู ูุญูู ูุง ุชูู ุนู 50%", "ุงูููุน": "ุชูุธููู", "ุงูุฃููููุฉ": "ุนุงููุฉ", "ุงูุชุฎุตุต": "ูุญุชูู ูุญูู"},
            {"ุงููุชุทูุจ": "ุชูุฏูู ุถูุงู ุจููู ุจูุณุจุฉ 10%", "ุงูููุน": "ูุงูู", "ุงูุฃููููุฉ": "ูุชูุณุทุฉ", "ุงูุชุฎุตุต": "ูุงูู"},
            {"ุงููุชุทูุจ": "ุชูููุฐ ุงููุดุฑูุน ูู ูุฏุฉ ูุง ุชุชุฌุงูุฒ 18 ุดูุฑ", "ุงูููุน": "ุฒููู", "ุงูุฃููููุฉ": "ุนุงููุฉ", "ุงูุชุฎุตุต": "ุฅุฏุงุฑุฉ ูุดุงุฑูุน"},
        ]
        
        sample_df = pd.DataFrame(sample_requirements)
        st.table(sample_df)
        return
    
    # ุนุฑุถ ูุนูููุงุช ุงูููุงูุตุฉ
    results = st.session_state.analysis_results
    st.markdown(f"### ุชุญููู ูุชุทูุจุงุช ุงูููุงูุตุฉ ุฑูู {results['tender_id']}")
    
    # ุฅูุดุงุก ุจูุงูุงุช ุงููุชุทูุจุงุช (ูุณุชุฎุฏู ุงูุจูุงูุงุช ุงููุชุงุญุฉ ุฃู ูุถูู ุชูุงุตูู ุฅุถุงููุฉ)
    # ูู ุงูุชุทุจูู ุงููุนููุ ุณุชููู ูุฐู ุงูุจูุงูุงุช ูู ูุชุงุฆุฌ ุงูุชุญููู ุงูุญูููู
    requirements = []
    
    for i, req in enumerate(results.get("requirements", [])):
        # ุฅูุดุงุก ุชูุงุตูู ุนุดูุงุฆูุฉ ููู ูุชุทูุจ ููุชูุถูุญ
        req_type = np.random.choice(["ููู", "ุฅุฏุงุฑู", "ุชุนุงูุฏู", "ุชูุธููู", "ูุงูู", "ุฒููู"])
        priority = np.random.choice(["ุนุงููุฉ", "ูุชูุณุทุฉ", "ููุฎูุถุฉ"], p=[0.5, 0.3, 0.2])
        
        specializations = {
            "ููู": ["ููุฏุณุฉ", "ุชูููุฉ ุงููุนูููุงุช", "ุงุชุตุงูุงุช", "ููุฑุจุงุก", "ูููุงูููุง"],
            "ุฅุฏุงุฑู": ["ุฅุฏุงุฑุฉ ูุดุงุฑูุน", "ููุงุฑุฏ ุจุดุฑูุฉ", "ุชุฏุฑูุจ", "ุฌูุฏุฉ"],
            "ุชุนุงูุฏู": ["ูุงูููู", "ูุดุชุฑูุงุช", "ุนููุฏ", "ุตูุงูุฉ"],
            "ุชูุธููู": ["ุงูุชุซุงู", "ุฃูู ุงููุนูููุงุช", "ูุญุชูู ูุญูู", "ุจูุฆุฉ"],
            "ูุงูู": ["ูุญุงุณุจุฉ", "ุถูุงูุงุช", "ุชูููู", "ูุงูู"],
            "ุฒููู": ["ุฅุฏุงุฑุฉ ูุดุงุฑูุน", "ุฌุฏููุฉ", "ุชุฎุทูุท"]
        }
        
        specialization = np.random.choice(specializations.get(req_type, ["ุนุงู"]))
        
        requirements.append({
            "ุงููุชุทูุจ": req,
            "ุงูููุน": req_type,
            "ุงูุฃููููุฉ": priority,
            "ุงูุชุฎุตุต": specialization
        })
    
    # ุฅุฐุง ูู ุชูู ููุงู ูุชุทูุจุงุชุ ุฅูุดุงุก ุจูุงูุงุช ุชูุถูุญูุฉ
    if not requirements:
        requirements = [
            {"ุงููุชุทูุจ": "ุชูุฑูุฏ ูุชุฑููุจ ูุนุฏุงุช", "ุงูููุน": "ููู", "ุงูุฃููููุฉ": "ุนุงููุฉ", "ุงูุชุฎุตุต": "ููุฏุณุฉ"},
            {"ุงููุชุทูุจ": "ุชุฏุฑูุจ ุงูููุธููู", "ุงูููุน": "ุฅุฏุงุฑู", "ุงูุฃููููุฉ": "ูุชูุณุทุฉ", "ุงูุชุฎุตุต": "ุชุฏุฑูุจ"},
            {"ุงููุชุทูุจ": "ุตูุงูุฉ ุฏูุฑูุฉ", "ุงูููุน": "ุชุนุงูุฏู", "ุงูุฃููููุฉ": "ูุชูุณุทุฉ", "ุงูุชุฎุตุต": "ุตูุงูุฉ"},
            {"ุงููุชุทูุจ": "ุงูุงูุชุซุงู ูููุนุงููุฑ", "ุงูููุน": "ุชูุธููู", "ุงูุฃููููุฉ": "ุนุงููุฉ", "ุงูุชุฎุตุต": "ุงูุชุซุงู"},
            {"ุงููุชุทูุจ": "ุชูุฏูู ุถูุงูุงุช ูุงููุฉ", "ุงูููุน": "ูุงูู", "ุงูุฃููููุฉ": "ุนุงููุฉ", "ุงูุชุฎุตุต": "ูุงูู"}
        ]
    
    # ุชุญููู ุงูุจูุงูุงุช ุฅูู DataFrame
    requirements_df = pd.DataFrame(requirements)
    
    # ุชุจููุจุงุช ูุนุฑุถ ุงููุชุทูุจุงุช ุจุทุฑู ูุฎุชููุฉ
    tab1, tab2, tab3 = st.tabs(["ูุงุฆูุฉ ุงููุชุทูุจุงุช", "ุชุตููู ุงููุชุทูุจุงุช", "ุชุญููู ุงููุชุทูุจุงุช"])
    
    # ุชุจููุจ ูุงุฆูุฉ ุงููุชุทูุจุงุช
    with tab1:
        st.markdown("### ูุงุฆูุฉ ูุชุทูุจุงุช ุงูููุงูุตุฉ")
        st.dataframe(requirements_df, use_container_width=True)
        
        # ุฎูุงุฑ ุชุตููุฉ ุงููุชุทูุจุงุช
        st.markdown("### ุชุตููุฉ ุงููุชุทูุจุงุช")
        
        col1, col2 = st.columns(2)
        
        with col1:
            selected_type = st.selectbox(
                "ุชุตููุฉ ุญุณุจ ุงูููุน",
                ["ุงููู"] + sorted(requirements_df["ุงูููุน"].unique().tolist())
            )
        
        with col2:
            selected_priority = st.selectbox(
                "ุชุตููุฉ ุญุณุจ ุงูุฃููููุฉ",
                ["ุงููู"] + sorted(requirements_df["ุงูุฃููููุฉ"].unique().tolist())
            )
        
        # ุชุทุจูู ุงูุชุตููุฉ
        filtered_df = requirements_df.copy()
        
        if selected_type != "ุงููู":
            filtered_df = filtered_df[filtered_df["ุงูููุน"] == selected_type]
        
        if selected_priority != "ุงููู":
            filtered_df = filtered_df[filtered_df["ุงูุฃููููุฉ"] == selected_priority]
        
        if selected_type != "ุงููู" or selected_priority != "ุงููู":
            st.markdown("### ุงููุชุทูุจุงุช ุงููุตูุงุฉ")
            st.dataframe(filtered_df, use_container_width=True)
    
    # ุชุจููุจ ุชุตููู ุงููุชุทูุจุงุช
    with tab2:
        st.markdown("### ุชุตููู ุงููุชุทูุจุงุช ุญุณุจ ุงูููุน ูุงูุฃููููุฉ")
        
        # ุฑุณู ุจูุงูู ูููุชุทูุจุงุช ุญุณุจ ุงูููุน
        type_counts = requirements_df["ุงูููุน"].value_counts().reset_index()
        type_counts.columns = ["ุงูููุน", "ุงูุนุฏุฏ"]
        
        fig1 = px.bar(
            type_counts, 
            x="ุงูููุน", 
            y="ุงูุนุฏุฏ",
            color="ุงูููุน",
            title="ุชูุฒูุน ุงููุชุทูุจุงุช ุญุณุจ ุงูููุน"
        )
        
        st.plotly_chart(fig1, use_container_width=True)
        
        # ุฑุณู ุจูุงูู ูููุชุทูุจุงุช ุญุณุจ ุงูุฃููููุฉ
        priority_counts = requirements_df["ุงูุฃููููุฉ"].value_counts().reset_index()
        priority_counts.columns = ["ุงูุฃููููุฉ", "ุงูุนุฏุฏ"]
        
        # ุชุฑุชูุจ ุงูุฃููููุงุช
        priority_order = {"ุนุงููุฉ": 1, "ูุชูุณุทุฉ": 2, "ููุฎูุถุฉ": 3}
        priority_counts["ุงูุชุฑุชูุจ"] = priority_counts["ุงูุฃููููุฉ"].map(priority_order)
        priority_counts = priority_counts.sort_values("ุงูุชุฑุชูุจ")
        
        # ุงุฎุชูุงุฑ ุงูุฃููุงู ุญุณุจ ุงูุฃููููุฉ
        color_map = {"ุนุงููุฉ": "#FF5733", "ูุชูุณุทุฉ": "#FFC300", "ููุฎูุถุฉ": "#33FF57"}
        colors = priority_counts["ุงูุฃููููุฉ"].map(color_map)
        
        fig2 = px.bar(
            priority_counts, 
            x="ุงูุฃููููุฉ", 
            y="ุงูุนุฏุฏ",
            color="ุงูุฃููููุฉ",
            color_discrete_map=color_map,
            title="ุชูุฒูุน ุงููุชุทูุจุงุช ุญุณุจ ุงูุฃููููุฉ"
        )
        
        st.plotly_chart(fig2, use_container_width=True)
    
    # ุชุจููุจ ุชุญููู ุงููุชุทูุจุงุช
    with tab3:
        st.markdown("### ุชุญููู ุงููุชุทูุจุงุช")
        
        # ุชูุฒูุน ุงููุชุทูุจุงุช ุญุณุจ ุงูุชุฎุตุต
        specialization_counts = requirements_df["ุงูุชุฎุตุต"].value_counts().reset_index()
        specialization_counts.columns = ["ุงูุชุฎุตุต", "ุงูุนุฏุฏ"]
        
        fig3 = px.pie(
            specialization_counts, 
            values="ุงูุนุฏุฏ", 
            names="ุงูุชุฎุตุต",
            title="ุชูุฒูุน ุงููุชุทูุจุงุช ุญุณุจ ุงูุชุฎุตุต",
            color_discrete_sequence=px.colors.qualitative.Bold
        )
        
        fig3.update_traces(textposition="inside", textinfo="percent+label")
        
        st.plotly_chart(fig3, use_container_width=True)
        
        # ูุตูููุฉ ุงููุชุทูุจุงุช (ุงูููุน ร ุงูุฃููููุฉ)
        heatmap_data = pd.crosstab(
            requirements_df["ุงูููุน"], 
            requirements_df["ุงูุฃููููุฉ"],
            margins=True, 
            margins_name="ุงูุฅุฌูุงูู"
        )
        
        # ุชุฑุชูุจ ุงูุฃุนูุฏุฉ (ุงูุฃููููุงุช)
        priority_columns = ["ุนุงููุฉ", "ูุชูุณุทุฉ", "ููุฎูุถุฉ", "ุงูุฅุฌูุงูู"]
        heatmap_data = heatmap_data.reindex(columns=priority_columns, fill_value=0)
        
        st.markdown("### ูุตูููุฉ ุงููุชุทูุจุงุช (ุงูููุน ร ุงูุฃููููุฉ)")
        st.dataframe(heatmap_data, use_container_width=True)
    
    # ุฎูุงุฑุงุช ุฅุถุงููุฉ
    st.markdown("### ุฎูุงุฑุงุช ุฅุถุงููุฉ")
    
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("ุชุตุฏูุฑ ุงููุชุทูุจุงุช ุฅูู Excel"):
            st.success("ุชู ุชุตุฏูุฑ ุงููุชุทูุจุงุช ุฅูู ููู Excel ุจูุฌุงุญ!")
    
    with col2:
        if st.button("ุงูุนูุฏุฉ ุฅูู ุชุญููู ุงูููุงูุตุฉ"):
            st.session_state.page = "ุชุญููู ุงูููุงูุตุงุช"
            st.experimental_rerun()

# ุงุฎุชุจุงุฑ ูุณุชูู ููุตูุญุฉ
if __name__ == "__main__":
    st.set_page_config(
        page_title="ูุธุงู ุชุญููู ุงูููุงูุตุงุช - ุชุญููู ุงููุชุทูุจุงุช",
        page_icon="๐",
        layout="wide",
    )
    show_requirements_analysis()